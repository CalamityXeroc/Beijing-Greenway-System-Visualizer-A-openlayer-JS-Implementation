<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北京温榆河滨水绿道</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-green: #4CAF50;
            --theme-blue: #2196F3;
            --theme-purple: #673AB7;
            --text-dark: #2c3e50;
            --text-light: #ffffff;
            --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.1);
            --border-radius: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', "Microsoft YaHei", sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--bg-gradient);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: var(--text-dark);
            padding: 2rem;
            text-align: center;
            margin: 2rem 2rem 0 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--theme-green), var(--theme-blue));
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, var(--theme-green), var(--theme-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .info-section {
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease;
        }

        .info-section:hover {
            transform: translateY(-5px);
        }

        .feature-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease;
        }

        .feature-image:hover {
            transform: scale(1.02);
        }

        .map-container {
            width: 100%;
            height: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-soft);
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .highlights {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .highlights h3 {
            color: var(--theme-blue);
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .highlights h3::before {
            content: '';
            display: block;
            width: 4px;
            height: 1em;
            background: linear-gradient(180deg, var(--theme-green), var(--theme-blue));
            border-radius: 2px;
        }

        .highlights ul {
            list-style-type: none;
        }

        .highlights li {
            margin: 1rem 0;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            position: relative;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            transition: transform 0.2s ease;
        }

        .highlights li:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.8);
        }

        .highlights li::before {
            content: "\f058";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--theme-green);
            position: absolute;
            left: 0.8rem;
            opacity: 0.8;
        }

        /* Mapbox 控件样式优化 */
        .mapboxgl-ctrl-group {
            border: none !important;
            border-radius: 12px !important;
            overflow: hidden;
            box-shadow: var(--shadow-soft) !important;
        }

        .mapboxgl-ctrl-group button {
            width: 36px !important;
            height: 36px !important;
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .mapboxgl-ctrl-group button:hover {
            background: rgba(255, 255, 255, 0.95) !important;
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header, .info-section {
            animation: fadeIn 0.8s ease backwards;
        }

        .info-section:nth-child(2) {
            animation-delay: 0.2s;
        }
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* 天气卡片样式 */
        .weather-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-top: 1rem;
        }

        .weather-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(52, 152, 219, 0.1);
        }

        .weather-icon {
            font-size: 2rem;
            color: var(--theme-blue);
        }

        .weather-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .weather-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .weather-item {
            text-align: center;
            padding: 1rem;
            background: rgba(33, 150, 243, 0.05);
            border-radius: 12px;
            transition: transform 0.2s ease;
        }

        .weather-item:hover {
            transform: translateY(-3px);
            background: rgba(33, 150, 243, 0.1);
        }

        .weather-item-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .weather-item-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-blue);
            margin-bottom: 0.25rem;
        }

        .weather-item-label {
            font-size: 0.85rem;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 1rem;
            color: #999;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
                max-width: 800px;
            }
            
            .header {
                margin: 1rem 1rem 0 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .weather-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .content {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem;
                margin: 0.5rem 0.5rem 0 0.5rem;
            }

            .info-section {
                padding: 1.5rem;
            }

            .highlights li {
                padding: 0.6rem 1rem 0.6rem 2rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>北京温榆河滨水绿道</h1>
        <p><i class="fas fa-leaf" style="color: var(--theme-green); margin-right: 0.5rem;"></i>沿河而行，探索城市绿色长廊</p>
    </header>

    <div class="content">
        <div class="info-section">
            <img src="数据/绿道/温榆河绿道/温榆河风景.jpg" alt="温榆河绿道景观" class="feature-image">
            <div class="highlights">
                <h3><i class="fas fa-star" style="color: var(--theme-green);"></i>绿道亮点</h3>
                <ul>
                    <li>
                        <strong style="color: var(--theme-blue)">总长度：</strong>
                        <span style="color: #666">108公里</span>
                    </li>
                    <li>
                        <strong style="color: var(--theme-blue)">覆盖区域：</strong>
                        <span style="color: #666">昌平、顺义、朝阳、通州四区</span>
                    </li>
                    <li>
                        <strong style="color: var(--theme-blue)">建设面积：</strong>
                        <span style="color: #666">417公顷</span>
                    </li>
                    <li>
                        <strong style="color: var(--theme-blue)">特色：</strong>
                        <span style="color: #666">滨水生态景观、休闲步道系统</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="info-section">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <!-- 天气信息卡片 -->
            <div class="weather-card">
                <div class="weather-header">
                    <i class="fas fa-cloud-sun weather-icon"></i>
                    <h3 class="weather-title">实时天气信息</h3>
                </div>
                <div id="weather-content" class="weather-content">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载天气数据...
                    </div>
                </div>
            </div>
            
            <div class="highlights">
                <h3><i class="fas fa-info-circle" style="color: var(--theme-blue);"></i>绿道简介</h3>
                <p style="line-height: 1.8; color: #666; padding: 0 0.5rem;">温榆河滨水绿道是北京市级滨水型绿道，发源于昌平区军都山麓，自沙河水库至通州区北关拦河闸段为大运河上游。沿线串联多个生态景观节点，包括巩华城、沙河闸公园、未来科技城滨水公园等，是市民休闲游憩的绝佳去处。</p>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; padding: 0 0.5rem;">
                    <span class="badge" style="background: rgba(76, 175, 80, 0.1); color: var(--theme-green); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.9rem;">
                        <i class="fas fa-tree"></i> 生态景观
                    </span>
                    <span class="badge" style="background: rgba(33, 150, 243, 0.1); color: var(--theme-blue); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.9rem;">
                        <i class="fas fa-water"></i> 滨水休闲
                    </span>
                    <span class="badge" style="background: rgba(103, 58, 183, 0.1); color: var(--theme-purple); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.9rem;">
                        <i class="fas fa-bicycle"></i> 运动健身
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 配置中心 ====================
        const APP_CONFIG = {
            map: {
                center: [116.5, 40],
                zoom: 10,
                geojson: '数据/绿道/温榆河绿道/温榆河.geojson'
            },
            weather: {
                apiKey: 'd9dd334682ca1fc6537ffaaccf795fbd',
                updateInterval: 30 * 60 * 1000, // 30分钟
                endpoints: {
                    geocode: 'https://restapi.amap.com/v3/geocode/regeo',
                    weather: 'https://restapi.amap.com/v3/weather/weatherInfo'
                }
            },
            greenway: {
                name: '温榆河绿道',
                style: {
                    color: '#2196F3',
                    width: 4
                },
                info: {
                    totalLength: '108公里',
                    areas: ['昌平', '顺义', '朝阳', '通州'],
                    buildArea: '417公顷',
                    features: ['滨水生态景观', '休闲步道系统']
                }
            }
        };

        // ==================== 地图管理器 ====================
        class GreenwayMapManager {
            constructor(config) {
                this.config = config;
                this.map = null;
                this.view = null;
                this.greenwayLayer = null;
            }

            init() {
                // 创建底图
                const baseLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://webrd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                        crossOrigin: 'anonymous'
                    })
                });

                // 创建视图
                this.view = new ol.View({
                    center: ol.proj.fromLonLat(this.config.map.center),
                    zoom: this.config.map.zoom
                });

                // 创建地图
                this.map = new ol.Map({
                    target: 'map',
                    layers: [baseLayer],
                    view: this.view
                });

                // 加载绿道图层
                this.loadGreenwayLayer();

                console.log('地图初始化完成');
            }

            loadGreenwayLayer() {
                const source = new ol.source.Vector({
                    url: this.config.map.geojson,
                    format: new ol.format.GeoJSON()
                });

                this.greenwayLayer = new ol.layer.Vector({
                    source: source,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: this.config.greenway.style.color,
                            width: this.config.greenway.style.width
                        })
                    })
                });

                this.map.addLayer(this.greenwayLayer);
            }

            getCenter() {
                return ol.proj.toLonLat(this.view.getCenter());
            }
        }

        // ==================== 天气管理器 ====================
        class WeatherManager {
            constructor(config, mapManager) {
                this.config = config;
                this.mapManager = mapManager;
                this.updateTimer = null;
                this.lastUpdate = null;
                this.currentWeather = null;
            }

            async init() {
                await this.fetchAndDisplay();
                this.startAutoUpdate();
            }

            async fetchAndDisplay() {
                try {
                    const weather = await this.fetchWeather();
                    this.currentWeather = weather;
                    this.lastUpdate = new Date();
                    this.displayWeather(weather);
                } catch (error) {
                    console.error('获取天气失败:', error);
                    this.showError('天气数据加载失败');
                }
            }

            async fetchWeather() {
                const [longitude, latitude] = this.mapManager.getCenter();
                console.log('获取天气，坐标:', longitude, latitude);

                // 1. 逆地理编码获取城市代码
                const geoResponse = await fetch(
                    `${this.config.weather.endpoints.geocode}?key=${this.config.weather.apiKey}&location=${longitude},${latitude}`
                );
                const geoData = await geoResponse.json();

                if (geoData.status !== '1' || !geoData.regeocode) {
                    throw new Error('位置解析失败: ' + (geoData.info || '未知错误'));
                }

                const adcode = geoData.regeocode.addressComponent.adcode;
                const cityName = geoData.regeocode.addressComponent.city || 
                               geoData.regeocode.addressComponent.province;
                console.log('城市:', cityName, '代码:', adcode);

                // 2. 获取天气数据
                const weatherResponse = await fetch(
                    `${this.config.weather.endpoints.weather}?key=${this.config.weather.apiKey}&city=${adcode}&extensions=base`
                );
                const weatherData = await weatherResponse.json();

                if (weatherData.status !== '1' || !weatherData.lives || weatherData.lives.length === 0) {
                    throw new Error('天气数据获取失败: ' + (weatherData.info || '未知错误'));
                }

                return {
                    ...weatherData.lives[0],
                    city: cityName,
                    updateTime: new Date()
                };
            }

            displayWeather(weather) {
                const weatherContent = document.getElementById('weather-content');
                
                const weatherIcons = {
                    '晴': 'fa-sun',
                    '多云': 'fa-cloud-sun',
                    '阴': 'fa-cloud',
                    '雨': 'fa-cloud-rain',
                    '雪': 'fa-snowflake',
                    '雷阵雨': 'fa-cloud-bolt'
                };
                
                const weatherIcon = weatherIcons[weather.weather] || 'fa-cloud';
                
                weatherContent.innerHTML = `
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas ${weatherIcon}" style="color: #FF9800;"></i>
                        </div>
                        <div class="weather-item-value">${weather.weather}</div>
                        <div class="weather-item-label">天气状况</div>
                    </div>
                    
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas fa-temperature-high" style="color: #F44336;"></i>
                        </div>
                        <div class="weather-item-value">${weather.temperature}°C</div>
                        <div class="weather-item-label">实时气温</div>
                    </div>
                    
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas fa-wind" style="color: #2196F3;"></i>
                        </div>
                        <div class="weather-item-value">${weather.winddirection}风</div>
                        <div class="weather-item-label">${weather.windpower}级</div>
                    </div>
                    
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas fa-tint" style="color: #00BCD4;"></i>
                        </div>
                        <div class="weather-item-value">${weather.humidity}%</div>
                        <div class="weather-item-label">空气湿度</div>
                    </div>
                    
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas fa-clock" style="color: #9C27B0;"></i>
                        </div>
                        <div class="weather-item-value">${weather.reporttime.split(' ')[1]}</div>
                        <div class="weather-item-label">更新时间</div>
                    </div>
                    
                    <div class="weather-item">
                        <div class="weather-item-icon">
                            <i class="fas fa-map-marker-alt" style="color: #4CAF50;"></i>
                        </div>
                        <div class="weather-item-value">${weather.city || '北京'}</div>
                        <div class="weather-item-label">所在城市</div>
                    </div>
                `;

                console.log('天气显示完成:', weather);
            }

            showError(message) {
                const weatherContent = document.getElementById('weather-content');
                weatherContent.innerHTML = `
                    <div class="loading" style="color: #f44336; text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">${message}</p>
                        <button onclick="weatherManager.fetchAndDisplay()" 
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 重新加载
                        </button>
                    </div>
                `;
            }

            startAutoUpdate() {
                // 清除旧的定时器
                if (this.updateTimer) {
                    clearInterval(this.updateTimer);
                }

                // 设置新的定时器
                this.updateTimer = setInterval(() => {
                    console.log('自动更新天气...');
                    this.fetchAndDisplay();
                }, this.config.weather.updateInterval);

                console.log(`天气自动更新已启动，间隔: ${this.config.weather.updateInterval / 60000} 分钟`);
            }

            stopAutoUpdate() {
                if (this.updateTimer) {
                    clearInterval(this.updateTimer);
                    this.updateTimer = null;
                    console.log('天气自动更新已停止');
                }
            }

            getLastUpdateTime() {
                if (!this.lastUpdate) return '未更新';
                const now = new Date();
                const diff = Math.floor((now - this.lastUpdate) / 1000 / 60);
                return diff < 1 ? '刚刚' : `${diff}分钟前`;
            }
        }

        // ==================== 应用初始化 ====================
        let mapManager, weatherManager;

        // 初始化应用
        async function initApp() {
            try {
                // 初始化地图
                mapManager = new GreenwayMapManager(APP_CONFIG);
                mapManager.init();

                // 等待地图稳定后初始化天气
                setTimeout(async () => {
                    weatherManager = new WeatherManager(APP_CONFIG, mapManager);
                    await weatherManager.init();
                }, 1000);

                console.log('应用初始化完成');
            } catch (error) {
                console.error('应用初始化失败:', error);
            }
        }

        // 启动应用
        initApp();

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            if (weatherManager) {
                weatherManager.stopAutoUpdate();
            }
        });

        console.log('温榆河绿道系统已启动');
    </script>
</body>
</html>